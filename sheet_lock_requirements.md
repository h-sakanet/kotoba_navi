# シートロック機能 要件定義

## 1. 目的
- 見て覚えるモードで、暗記済みセルをロックし、次回マスクON時に最初から透過表示にする。
- 暗記不要セルをシャッフル対象から外し、未暗記セルの学習効率を上げる。

## 2. 対象画面
- `WordList`（見て覚えるモード）
- `Test`（やり直し時のアンロック連携）

## 3. 用語
- シート: マスク対象の1表示単位（`group_members` はメンバー単位）
- 透過: 内容が見える状態
- 不透過: 青シートで隠れている状態
- ロック: 「次回マスクON時に初期透過で開始する」状態

## 4. 状態遷移（1セル）
- タップ操作:
1. 不透過 → 透過（アンロック）
2. 透過（アンロック） → 不透過
- 長押し操作（透過時のみ有効）:
1. 透過青（アンロック） → 透過黄（ロック）
2. 透過黄（ロック） → 透過青（アンロック）

補足:
- ロック状態はシート色で判別する（青=アンロック、黄=ロック）。
- 透過/不透過切り替えはタップ、ロック切り替えは長押しで行う。

## 5. 永続化要件
- 永続化対象はロック状態のみ（`boolean`）。
- マスクOFF時はシート自体は非表示だが、ロック状態は保持する。
- 画面再読み込み後、マスクON時はロック済みセルが初期透過となる。
- 再インポート時はロック状態を全クリアする。

## 6. 識別キー要件
- ロックキーは `word.id` ベースとする。
- 左右独立管理のため `side` を含める。
- グループメンバー単位管理のため `groupIndex` と `memberIndex` を含める。
- 例: `{ wordId, side, groupIndex, memberIndex }`

## 7. シャッフル要件
- シャッフル対象はアンロック群のみ。
- ロック群は下部に寄せ、群内は `word.id` 昇順で固定。
- アンロック群の並び替えは固定点ゼロ（Sattolo）を維持する。
- 全ロック時はシャッフルボタンを無効化する。

## 8. 編集モード要件
- 編集モード中にロック/アンロック変更を可能にする。
- 編集保存後もロック状態は維持する（編集で明示変更した場合を除く）。
- 編集モードではシート色以外でもロック状態を判別できるUIを提供する。

## 9. 習得欄UI要件（ことわざカテゴリ）
- `習得` 欄は2x2の4点表示とする。
- 上段左: 左ロック
- 上段右: 右ロック
- 下段左: 左テストOK
- 下段右: 右テストOK
- ON色は黄色系に統一する（ロック黄、習得100%表示、最終テスト有効色とのトーン統一）。

## 10. テスト連携要件（retry時アンロック）
- `Test` / `Final Test` で「やり直し」を選んだ語は、対応パネル側のみアンロックする。
- 意味テスト: 意味側をアンロック
- ことわざ（カテゴリ）テスト: ことわざ側をアンロック
- 左右パネルとの対応はカテゴリ設定に基づき決定する。

## 11. 実装方針（推奨）
- 既存 `CATEGORY_SETTINGS` に、テストごとのアンロック対象パネルを明示する設定を追加する。
  - 例: `retryUnlockSide: 'left' | 'right'`
- これによりカテゴリごとの例外分岐を `Test.tsx` から排除し、設定駆動を維持する。

## 12. 受け入れ条件
- ロック済みセルは、マスクOFF→ON後も初期透過で表示される。
- 左右別々にロックしても互いに影響しない。
- グループカテゴリでメンバー単位ロックが機能する。
- シャッフル時、ロック群は下部固定、アンロック群のみ並び替わる。
- 全ロック時、シャッフル操作は無効化される。
- テストの「やり直し」で、対応パネルのみアンロックされる。
